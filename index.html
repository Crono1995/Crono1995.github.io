<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Vision OCR - GitHub Pages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@google/genai@latest/dist/client.js"></script>
    <style>
        /* Custom styles based on the original component */
        .bg-gradient-hero {
            background: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);
        }
        .bg-gradient-primary {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
        }
        .bg-gradient-clip {
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .bg-card { background-color: white; }
        .border-border { border-color: #e5e7eb; }
        .text-primary { color: #4f46e5; }
        .hover\:border-primary\/50:hover { border-color: rgba(79, 70, 229, 0.5); }
        .variant-gradient {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-hero min-h-screen">
    <div id="app" class="container mx-auto px-6 py-12">
        </div>

    <script>
        // --- Configuration ---
        // !!! IMPORTANT: NEVER STORE YOUR GEMINI API KEY DIRECTLY IN A PUBLIC REPOSITORY !!!
        // This is for demonstration on GitHub Pages only.
        // For production, use a secure backend proxy to protect your key.
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE";
        const MODEL_NAME = "gemini-2.5-flash";

        // --- Utility Functions ---

        /** Converts a File object to a base64 Data URL expected by the Gemini API. */
        const fileToGenerativePart = async (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type,
                        },
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        // --- State Management (Simple object-based state) ---
        let state = {
            selectedFile: null,
            isProcessing: false,
            ocrResult: null,
            fileName: '',
            error: null,
            geminiClient: null,
        };

        // --- Component Rendering Functions (Simplified for vanilla JS) ---

        const renderApp = () => {
            const app = document.getElementById('app');
            app.innerHTML = ''; // Clear previous content

            if (state.ocrResult) {
                app.appendChild(OcrResult(state.ocrResult, state.fileName));
            } else {
                app.appendChild(MainScreen());
            }
            
            // Re-render Lucide icons after DOM update
            lucide.createIcons();
        };

        const OcrResult = (text, fileName) => {
            const div = document.createElement('div');
            div.className = "py-12";
            div.innerHTML = `
                <div class="max-w-4xl mx-auto bg-card border border-border rounded-lg shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-primary flex items-center">
                            <i data-lucide="check-circle" class="w-6 h-6 mr-2"></i>
                            OCR Complete
                        </h2>
                        <button id="resetButton" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition">
                            Process Another
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">
                        Text extracted from: <span class="font-semibold">${fileName}</span>
                    </p>
                    <div class="bg-gray-50 border border-gray-200 p-6 rounded-lg whitespace-pre-wrap max-h-[500px] overflow-y-auto">
                        ${text}
                    </div>
                    <button id="copyButton" class="mt-4 w-full px-4 py-2 variant-gradient rounded-md hover:opacity-90 transition">
                        <i data-lucide="copy" class="w-5 h-5 mr-2 inline-block"></i>
                        Copy Text
                    </button>
                </div>
            `;
            
            div.querySelector('#resetButton').onclick = handleReset;
            div.querySelector('#copyButton').onclick = () => {
                navigator.clipboard.writeText(text);
                alert('Text copied to clipboard!');
            };
            return div;
        };

        const MainScreen = () => {
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="text-center mb-12 space-y-4">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 rounded-full border border-primary/20">
                        <i data-lucide="scan" class="w-5 h-5 text-primary"></i>
                        <span class="text-sm font-medium text-primary">AI-Powered Vision OCR</span>
                    </div>
                    <h1 class="text-5xl font-bold tracking-tight">
                        Extract Text from Any
                        <span class="block bg-gradient-primary bg-gradient-clip">
                            Image or Document
                        </span>
                    </h1>
                    <p class="text-xl text-gray-500 max-w-2xl mx-auto">
                        Upload images and get accurate OCR results powered by Google Gemini vision.
                    </p>
                    ${state.error ? `<div class="mt-4 p-3 bg-red-100 text-red-700 rounded-md max-w-lg mx-auto">${state.error}</div>` : ''}
                </div>

                <div class="grid md:grid-cols-3 gap-6 mb-12 max-w-4xl mx-auto">
                    ${[
                        { title: 'Multi-format Support', desc: 'PNG, JPG, WEBP, HEIC' },
                        { title: 'Gemini Vision', desc: 'Advanced AI for high accuracy' },
                        { title: 'Frontend Only', desc: 'Works as a static page' },
                    ].map((feature, i) => `
                        <div key="${i}" class="bg-card border border-border rounded-lg p-6 hover:border-primary/50 transition-all hover:shadow-lg">
                            <h3 class="font-semibold mb-2">${feature.title}</h3>
                            <p class="text-sm text-gray-500">${feature.desc}</p>
                        </div>
                    `).join('')}
                </div>

                ${FileUploader()}

                ${state.selectedFile && !state.isProcessing ? `
                    <div class="flex justify-center mt-6">
                        <button id="extractButton" class="px-8 py-3 variant-gradient rounded-full shadow-lg hover:shadow-xl transition-all text-lg font-semibold">
                            <i data-lucide="scan" class="w-5 h-5 mr-2 inline-block"></i>
                            Extract Text
                        </button>
                    </div>
                ` : ''}

                <div class="mt-16 text-center">
                    <div class="inline-flex flex-col gap-2 p-6 bg-card border border-border rounded-lg">
                        <p class="text-sm text-gray-500">
                            üöÄ Powered by <span class="text-primary font-semibold">Gemini API</span>
                        </p>
                        <p class="text-xs text-gray-500">
                            Using Google Gemini 2.5 Flash for vision & OCR.
                        </p>
                    </div>
                </div>
            `;
            
            // Event listeners
            const fileInput = div.querySelector('#fileInput');
            if (fileInput) fileInput.onchange = handleFileChange;
            
            const dropArea = div.querySelector('#dropArea');
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                dropArea.addEventListener('drop', handleDrop, false);
            }

            const extractButton = div.querySelector('#extractButton');
            if (extractButton) extractButton.onclick = handleExtract;

            return div;
        };
        
        const FileUploader = () => {
            let content = '';
            if (state.selectedFile) {
                content = `
                    <div class="text-center">
                        <i data-lucide="file-check" class="w-12 h-12 mx-auto text-green-500 mb-2"></i>
                        <p class="font-semibold">${state.selectedFile.name}</p>
                        <p class="text-sm text-gray-500">Ready to process. Click 'Extract Text' below.</p>
                        <button id="clearFile" class="mt-2 text-red-500 text-sm hover:underline">Clear File</button>
                    </div>
                `;
            } else if (state.isProcessing) {
                 content = `
                    <div class="text-center">
                        <i data-lucide="loader" class="w-12 h-12 mx-auto text-primary animate-spin mb-2"></i>
                        <p class="font-semibold text-primary">Processing...</p>
                        <p class="text-sm text-gray-500">Extracting text using Gemini Vision API.</p>
                    </div>
                 `;
            } else {
                 content = `
                    <i data-lucide="file-up" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>
                    <p class="mb-2 font-semibold">Drag & drop an image here, or <span class="text-primary hover:text-indigo-600 transition cursor-pointer">browse</span></p>
                    <p class="text-xs text-gray-500">Max size 20MB. Supported: JPG, PNG, WEBP, HEIC.</p>
                 `;
            }

            const div = document.createElement('div');
            div.className = "max-w-2xl mx-auto";
            div.innerHTML = `
                <label id="dropArea" class="block w-full cursor-pointer rounded-xl border-2 border-dashed border-gray-300 p-12 text-center transition-all hover:border-primary/50 bg-white shadow-md">
                    <input id="fileInput" type="file" class="sr-only" accept="image/jpeg,image/png,image/webp,image/heic">
                    ${content}
                </label>
            `;

            if (state.selectedFile) {
                div.querySelector('#clearFile').onclick = handleReset;
            }

            return div.innerHTML;
        };

        // --- Event Handlers ---

        const handleFileChange = (event) => {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 20 * 1024 * 1024) { // 20MB limit
                    state.error = 'File size exceeds the 20MB limit.';
                    state.selectedFile = null;
                } else {
                    state.selectedFile = file;
                    state.fileName = file.name;
                    state.error = null;
                }
                renderApp();
            }
        };

        const preventDefaults = (e) => {
            e.preventDefault();
            e.stopPropagation();
        };

        const handleDrop = (e) => {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            if (file) {
                // Manually trigger the file change handler logic
                const mockEvent = { target: { files: [file] } };
                handleFileChange(mockEvent);
            }
        };

        const handleExtract = async () => {
            if (!state.selectedFile || state.isProcessing) return;

            state.isProcessing = true;
            state.error = null;
            renderApp();

            try {
                if (!state.geminiClient) {
                    state.geminiClient = new google.genai.GoogleGenAI(GEMINI_API_KEY);
                }

                // Convert file to a part for the API call
                const imagePart = await fileToGenerativePart(state.selectedFile);

                // Call the Gemini API for OCR
                const prompt = "You are an expert OCR system. Extract ALL text content from this image or document. Do not include any commentary, explanations, or analysis. Just output the raw extracted text in a clean, readable format, preserving line breaks and structure as much as possible.";
                
                const response = await state.geminiClient.models.generateContent({
                    model: MODEL_NAME,
                    contents: [imagePart, prompt],
                });

                const extractedText = response.text.trim();

                if (!extractedText) {
                    throw new Error("Gemini returned an empty result. Could not extract text.");
                }

                state.ocrResult = extractedText;
                
            } catch (error) {
                console.error("Gemini OCR Error:", error);
                state.error = "Failed to process the image. Check the console for details, or ensure your API key is correct and you have an active network connection.";
                state.ocrResult = null; // Clear result on error
            } finally {
                state.isProcessing = false;
                renderApp();
            }
        };

        const handleReset = () => {
            state.selectedFile = null;
            state.ocrResult = null;
            state.isProcessing = false;
            state.fileName = '';
            state.error = null;
            renderApp();
        };

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE" || !GEMINI_API_KEY) {
                state.error = "‚ö†Ô∏è Please replace 'YOUR_GEMINI_API_KEY_HERE' in the script with your actual Gemini API Key to enable functionality.";
            }
            renderApp();
        });
    </script>
</body>
</html>
