<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Log Analyzer Pro (Bash Logic)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Basic styling for the loader icon */
        .loader-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Destructure necessary React hooks
        const { useState, useCallback } = React;

        // =======================================================
        // 2. Mock/Stubbed Components & Hooks
        // (Replaces external libraries like Shadcn and Lucide)
        // =======================================================

        // Mock Lucide-React icons
        const Play = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const Loader2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>;

        // Mock Shadcn Components
        const Card = ({ children, className = "" }) => <div className={`bg-white shadow-xl rounded-lg ${className}`}>{children}</div>;
        const CardHeader = ({ children, className = "" }) => <div className={`p-4 ${className}`}>{children}</div>;
        const CardTitle = ({ children, className = "" }) => <h2 className={`text-2xl font-bold ${className}`}>{children}</h2>;
        const CardDescription = ({ children, className = "" }) => <p className={`text-gray-500 ${className}`}>{children}</p>;
        const CardContent = ({ children, className = "" }) => <div className={`p-6 pt-0 ${className}`}>{children}</div>;
        
        const Button = ({ children, onClick, disabled, className = "", size }) => (
            <button
                onClick={onClick}
                disabled={disabled}
                className={`flex items-center justify-center rounded-md text-white font-medium transition-colors ${
                    disabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'
                } ${className} ${size === 'lg' ? 'h-12 px-6 text-lg' : 'h-10 px-4'}`}
            >
                {children}
            </button>
        );

        // Mock useToast hook (using console log)
        const useToast = () => ({
            toast: ({ title, description, variant }) => {
                console.log(`[Toast - ${variant ? variant.toUpperCase() : 'INFO'}]: ${title} - ${description}`);
            },
        });

        // Simplified FileUpload Component
        const FileUpload = ({ onFileSelect, selectedFile }) => {
            const handleChange = (event) => {
                const file = event.target.files[0];
                onFileSelect(file || null);
            };

            return (
                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors">
                    <input
                        type="file"
                        onChange={handleChange}
                        className="hidden"
                        id="file-upload"
                        accept=".log, .txt"
                    />
                    <label htmlFor="file-upload" className="cursor-pointer block">
                        <p className="font-semibold text-gray-700">
                            {selectedFile ? `File Selected: ${selectedFile.name}` : "Click to select a Log File (.log, .txt)"}
                        </p>
                        <p className="text-sm text-gray-500">Max size 10MB. Analysis runs locally in your browser.</p>
                    </label>
                </div>
            );
        };

        // Simplified AnalysisOutput Component
        const AnalysisOutput = ({ output, error }) => {
            if (error) {
                return (
                    <div className="bg-red-100 border border-red-400 text-red-700 p-4 rounded-md overflow-x-auto">
                        <p className="font-bold">ðŸš¨ Error:</p>
                        <pre className="whitespace-pre-wrap text-sm mt-1">{error}</pre>
                    </div>
                );
            }
            if (output) {
                return (
                    <div className="bg-green-100 border border-green-400 text-green-700 p-4 rounded-md overflow-x-auto">
                        <p className="font-bold">âœ… Bash-Style Frequency Analysis:</p>
                        <pre className="text-sm mt-1">{output}</pre>
                    </div>
                );
            }
            return null;
        };


        // =======================================================
        // 3. Core Local Analysis Logic (Adapted from Bash Script)
        // =======================================================

        const analyzeContent = (content) => {
            // --- Step 1: Mimic Bash Cleanup and Normalization ---
            
            // 1.1. Split lines and strip the initial timestamp/host/PID format 
            // sed -E 's/(\w+)(\s+)([0-9]){1,2}(\s+)([0-9]{1,2}:){1,2}([0-9]{1,2})(\s+)//'
            let lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
            
            // Regex to remove common log prefixes like "Nov 17 10:41:54 servername "
            let processedLines = lines.map(line => 
                // Remove Month Day HH:MM:SS format
                line.replace(/^\S+\s+\d{1,2}\s+\d{1,2}:\d{2}:\d{2}\s+/, '')
                    // Remove potential remaining hostname/PID and leading/trailing whitespace
                    .trim()
            );

            // 1.2. Mimic 'sed -E s/\[.+\]//' (Removes content enclosed in brackets)
            processedLines = processedLines.map(line => line.replace(/\[.+?\]/g, '').trim());

            // 1.3. Mimic 'sed 's/[[:space:]]//g'' (Removes ALL whitespace)
            let strippedLines = processedLines.map(line => line.replace(/\s+/g, ''));
            
            // --- Step 2: Mimic 'sort -g | uniq -c | sort -hr' (Frequency Counting) ---
            const frequencyMap = new Map();
            const totalOriginalLines = strippedLines.length;

            strippedLines.forEach(line => {
                const key = line;
                frequencyMap.set(key, (frequencyMap.get(key) || 0) + 1);
            });

            // Convert Map to array of {count, line} objects and sort high to low
            let sortedFrequency = Array.from(frequencyMap, ([line, count]) => ({ count, line }))
                .sort((a, b) => b.count - a.count);

            // --- Step 3: Mimic 'wc -l' and 'bc -l' (Calculate Percentage) ---
            
            if (totalOriginalLines === 0) {
                return "Log file is empty after stripping metadata.";
            }

            // X = 100 / Total_Lines
            const basePercentage = 100 / totalOriginalLines;
            
            // --- Step 4: Mimic 'while read' loop (Format Output) ---
            let resultOutput = `\n`;
            resultOutput += `PERCENTAGE  | COUNT | MESSAGE FRAGMENT (Whitespace Stripped)\n`;
            resultOutput += `------------------------------------------------------------------------------------------------------------------------------------------------\n`;

            sortedFrequency.forEach(({ count, line }) => {
                // MATH = X * CANT, formatted to two decimal places
                const percentage = (basePercentage * count).toFixed(2);
                
                // Pad percentage for column alignment (0$MATH logic)
                const percentageDisplay = percentage.padStart(5, '0'); 
                
                // Format: ${MATH} \t${CANT}-\t-${LINE}
                const truncatedLine = line.substring(0, 100);
                
                // Use fixed spaces or pipe | for better alignment in the <pre> tag
                resultOutput += `${percentageDisplay}%   | ${count.toString().padStart(5, ' ')} | ${truncatedLine}\n`;
            });

            return resultOutput;
        };


        // =======================================================
        // 4. Main Component
        // =======================================================

        const Index = () => {
            const [selectedFile, setSelectedFile] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [output, setOutput] = useState("");
            const [error, setError] = useState("");
            const { toast } = useToast();

            const handleAnalyze = useCallback(async () => {
                if (!selectedFile) {
                    toast({ variant: "destructive", title: "No file selected", description: "Please upload a log file first" });
                    return;
                }

                const maxSize = 10 * 1024 * 1024; // 10MB limit
                if (selectedFile.size > maxSize) {
                    toast({ variant: "destructive", title: "File too large", description: "Maximum file size is 10MB" });
                    return;
                }

                setIsAnalyzing(true);
                setError("");
                setOutput("");

                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const fileContent = e.target.result;
                        
                        // Run the local analysis function
                        const analysisResult = analyzeContent(fileContent);

                        setOutput(analysisResult);
                        toast({ title: "Analysis complete", description: "Bash logic successfully adapted and run locally." });

                    } catch (err) {
                        const errorMessage = err.message || "Error reading or processing file locally.";
                        setError(errorMessage);
                        toast({ variant: "destructive", title: "Local Analysis Error", description: errorMessage });
                    } finally {
                        setIsAnalyzing(false);
                    }
                };

                reader.onerror = () => {
                    setError("Failed to read the file. Ensure it is a text file.");
                    setIsAnalyzing(false);
                };

                // Start reading the file as plain text
                reader.readAsText(selectedFile);
            }, [selectedFile, toast]);

            return (
                <div className="min-h-screen bg-gray-50 py-8 px-4">
                    <div className="container max-w-4xl mx-auto">
                        <Card className="border-2 border-gray-200">
                            <CardHeader className="text-center pb-4">
                                <div className="flex items-center justify-center mb-2">
                                    <div className="bg-blue-100 p-3 rounded-lg">
                                        <Play className="w-8 h-8 text-blue-600" />
                                    </div>
                                </div>
                                <CardTitle className="text-3xl font-bold">Local Log Analyzer (Bash Style)</CardTitle>
                                <CardDescription className="text-base">
                                    Upload log files to run frequency analysis based on your custom Bash script logic.
                                </CardDescription>
                            </CardHeader>
                            
                            <CardContent className="space-y-6">
                                <FileUpload onFileSelect={setSelectedFile} selectedFile={selectedFile} />
                                
                                <Button
                                    onClick={handleAnalyze}
                                    disabled={!selectedFile || isAnalyzing}
                                    className="w-full text-base font-semibold"
                                    size="lg"
                                >
                                    {isAnalyzing ? (
                                        <>
                                            <Loader2 className="mr-2 h-5 w-5 text-white loader-spin" />
                                            Translating Bash to JS...
                                        </>
                                    ) : (
                                        <>
                                            <Play className="mr-2 h-5 w-5 text-white" />
                                            Start Local Analysis
                                        </>
                                    )}
                                </Button>

                                <AnalysisOutput output={output} error={error} />
                            </CardContent>
                        </Card>

                        <div className="mt-6 text-center text-sm text-gray-500">
                            <p>Powered by native browser JavaScript â€¢ **100% Client-Side** â€¢ Secure analysis</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the component
        ReactDOM.render(<Index />, document.getElementById('root'));
    </script>
</body>
</html>
