import { useState, useCallback, useMemo, useEffect } from 'react';
import { Box, Download, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
// Assuming these are your components from the previous version
import { ImageUpload } from '@/components/ImageUpload'; 
import { DepthMapViewer } from '@/components/DepthMapViewer';
import { Viewer3D } from '@/components/Viewer3D'; // Needs to be updated/created
import { DepthEstimator } from '@/lib/depthEstimation'; // Now imported from the new file
import { MeshGenerator } from '@/lib/meshGenerator';   // Now imported from the new file
import { useToast } from '@/hooks/use-toast';
import * as THREE from 'three';

// ---------------------------------------------------------------------------------------------------
// UTILITY: Image Resize (Typically lives in '@/lib/utils.ts')
// This is essential for preventing browser crashes with high-res images.
// ---------------------------------------------------------------------------------------------------
async function resizeImageToMax(img: HTMLImageElement, maxSize = 1024): Promise<HTMLImageElement> {
    if (img.naturalWidth <= maxSize && img.naturalHeight <= maxSize) {
        return img;
    }

    const scale = Math.min(maxSize / img.naturalWidth, maxSize / img.naturalHeight);
    const w = Math.max(1, Math.round(img.naturalWidth * scale));
    const h = Math.max(1, Math.round(img.naturalHeight * scale));

    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    
    if (ctx) {
        ctx.imageSmoothingEnabled = true;
        (ctx as any).imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, w, h);
    }
    
    const resizedImg = new Image();
    resizedImg.crossOrigin = 'anonymous';
    resizedImg.src = canvas.toDataURL('image/png');
    await new Promise((res, rej) => { resizedImg.onload = res; resizedImg.onerror = rej; });
    return resizedImg;
}

// ---------------------------------------------------------------------------------------------------
// MAIN COMPONENT
// ---------------------------------------------------------------------------------------------------

const Index = () => {
Â  const [selectedImage, setSelectedImage] = useState<string | null>(null);
Â  const [depthMap, setDepthMap] = useState<ImageData | null>(null);
Â  const [mesh, setMesh] = useState<THREE.BufferGeometry | null>(null);
Â  const [isProcessing, setIsProcessing] = useState(false);
Â  const [modelLoadProgress, setModelLoadProgress] = useState(0); // For the AI model loading bar
Â  const { toast } = useToast();

Â  // Initialize classes using useMemo to ensure they are consistent instances
Â  const depthEstimator = useMemo(() => new DepthEstimator(), []);
Â  const meshGenerator = useMemo(() => new MeshGenerator(), []);

Â  const handleImageSelect = useCallback((file: File) => {
Â  Â  const reader = new FileReader();
Â  Â  reader.onload = (e) => {
Â  Â  Â  setSelectedImage(e.target?.result as string);
Â  Â  Â  setDepthMap(null);
Â  Â  Â  setMesh(null);
Â  Â  Â  // Reset model progress if a new image is selected before processing
Â  Â  Â  setModelLoadProgress(0); 
Â  Â  };
Â  Â  reader.readAsDataURL(file);
Â  }, []);

Â  // Function to handle model loading progress from DepthEstimator
Â  const handleModelProgress = useCallback((fraction: number) => {
Â  Â  setModelLoadProgress(Math.round(fraction * 100));
Â  }, []);

Â  const handleGenerate = async () => {
Â  Â  if (!selectedImage) {
Â  Â  Â  toast({
Â  Â  Â  Â  title: "No image selected",
Â  Â  Â  Â  description: "Please upload an image first",
Â  Â  Â  Â  variant: "destructive",
Â  Â  Â  });
Â  Â  Â  return;
Â  Â  }

Â  Â  setIsProcessing(true);
Â  Â  clear3DViewer(); // Clear previous mesh before starting

Â  Â  try {
Â  Â  Â  // 1) Load original image (used for high-res texture on the final mesh)
Â  Â  Â  const img = new Image();
Â  Â  Â  img.crossOrigin = 'anonymous';
Â  Â  Â  img.src = selectedImage;
Â  Â  Â  await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

Â  Â  Â  // 2) Resize a copy for depth estimation/mesh generation (performance)
Â  Â  Â  const MAX_PROCESS_SIZE = 1024;
Â  Â  Â  const resizedForDepth = await resizeImageToMax(img, MAX_PROCESS_SIZE);

Â  Â  Â  // 3) Load AI Model (if not already loaded)
Â  Â  Â  // The loadModel is called inside estimateDepth, which handles the progress update
Â  Â  Â  toast({
Â  Â  Â  Â  title: "Processing image",
Â  Â  Â  Â  description: "Loading AI model and estimating depth map...",
Â  Â  Â  });

Â  Â  Â  // 4) Estimate depth using the RESIZED image
Â  Â  Â  // Pass the progress handler to the DepthEstimator
Â  Â  Â  const estimatedDepth = await depthEstimator.estimateDepth(resizedForDepth, handleModelProgress);
Â  Â  Â  setDepthMap(new ImageData(estimatedDepth.data, estimatedDepth.width, estimatedDepth.height));
Â  Â  Â  setModelLoadProgress(100); // Set to 100% after processing starts

Â  Â  Â  toast({
Â  Â  Â  Â  title: "Generating 3D model",
Â  Â  Â  Â  description: "Creating mesh from depth data...",
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // 5) Generate mesh
Â  Â  Â  const generatedMesh = meshGenerator.generateMeshFromDepth(estimatedDepth);
Â  Â  Â  setMesh(generatedMesh);

Â  Â  Â  toast({
Â  Â  Â  Â  title: "Success!",
Â  Â  Â  Â  description: "3D model generated successfully. Try rotating it!",
Â  Â  Â  Â  variant: "success",
Â  Â  Â  });

Â  Â  } catch (error) {
Â  Â  Â  console.error('Generation error:', error);
Â  Â  Â  toast({
Â  Â  Â  Â  title: "Generation failed",
Â  Â  Â  Â  description: error instanceof Error ? error.message : "An unknown error occurred",
Â  Â  Â  Â  variant: "destructive",
Â  Â  Â  });
Â  Â  Â  setModelLoadProgress(0);
Â  Â  } finally {
Â  Â  Â  setIsProcessing(false);
Â  Â  Â  // Hide loading bar after a small delay if it finished successfully
Â  Â  Â  setTimeout(() => setModelLoadProgress(0), 1000); 
Â  Â  }
Â  };

Â  const handleExport = () => {
Â  Â  if (!mesh) {
Â  Â  Â  toast({ title: "No model to export", description: "Please generate a 3D model first", variant: "destructive" });
Â  Â  Â  return;
Â  Â  }
Â  Â  try {
Â  Â  Â  const objContent = meshGenerator.exportToOBJ(mesh);
Â  Â  Â  meshGenerator.downloadOBJ(objContent);
Â  Â  Â  toast({ title: "Export successful", description: "OBJ file downloaded", variant: 'success' });
Â  Â  } catch (error) {
Â  Â  Â  toast({ title: "Export failed", description: "Failed to export the model", variant: "destructive" });
Â  Â  }
Â  };
    
  // Placeholder for clearing the viewer (actual logic resides in Viewer3D)
  const clear3DViewer = () => {
    // In a React context, clearing the mesh state triggers the Viewer3D component to clean up
    setMesh(null);
  };
    
  const showModelLoading = modelLoadProgress > 0 && modelLoadProgress < 100;

Â  return (
Â  Â  <div className="min-h-screen bg-background py-8 px-4">
Â  Â  Â  <div className="max-w-7xl mx-auto">
Â  Â  Â  Â  {/* Header */}
Â  Â  Â  Â  <div className="text-center mb-12">
Â  Â  Â  Â  Â  <div className="flex items-center justify-center gap-3 mb-4">
Â  Â  Â  Â  Â  Â  <Box className="w-10 h-10 text-primary" />
Â  Â  Â  Â  Â  Â  <h1 className="text-5xl font-bold text-gradient">
Â  Â  Â  Â  Â  Â  Â  AI 3D Model Generator
Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <p className="text-muted-foreground text-lg">
Â  Â  Â  Â  Â  Â  Transform 2D images into 3D models using AI â€¢ 100% Client-Side â€¢ No Server Required
Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {/* Main Content */}
Â  Â  Â  Â  <div className="grid lg:grid-cols-2 gap-6 mb-8">
Â  Â  Â  Â  Â  {/* Left Column */}
Â  Â  Â  Â  Â  <Card className="p-6 space-y-6">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <span className="text-primary">1.</span> Upload Image
Â  Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  Â  <ImageUpload
Â  Â  Â  Â  Â  Â  Â  Â  onImageSelect={handleImageSelect}
Â  Â  Â  Â  Â  Â  Â  Â  selectedImage={selectedImage}
Â  Â  Â  Â  Â  Â  Â  Â  isProcessing={isProcessing}
Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <span className="text-primary">2.</span> Depth Map
Â  Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  Â  <DepthMapViewer depthMap={depthMap} />
Â  Â  Â  Â  Â  Â  </div>
                
            {/* AI Model Loading Progress Bar (From vanilla code) */}
            <div className={`space-y-2 pt-6 ${showModelLoading ? '' : 'hidden'}`}>
                <h3 className="text-sm font-medium text-gray-700 flex items-center gap-2">
                    <Loader2 className="w-4 h-4 text-primary animate-spin" />
                    Loading AI Model Progress:
                    <span id="model-progress-text" className="font-bold">{modelLoadProgress}%</span>
                </h3>
                <div className="w-full bg-gray-200 rounded-full h-2.5">
                    <div 
                        id="model-progress-bar" 
                        className="bg-primary h-2.5 rounded-full transition-all duration-100" 
                        style={{ width: `${modelLoadProgress}%` }}
                    ></div>
                </div>
            </div>
Â  Â  Â  Â  Â  </Card>

Â  Â  Â  Â  Â  {/* Right Column */}
Â  Â  Â  Â  Â  <Card className="p-6 space-y-6">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <span className="text-primary">3.</span> 3D Model Viewer
Â  Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  Â  {/* The Viewer3D component must be implemented to use the provided Three.js logic */}
Â  Â  Â  Â  Â  Â  Â  <Viewer3D 
                 mesh={mesh} 
                 textureImageSrc={selectedImage} 
                 isProcessing={isProcessing} 
               />
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div className="space-y-3">
Â  Â  Â  Â  Â  Â  Â  <Button
Â  Â  Â  Â  Â  Â  Â  Â  onClick={handleGenerate}
Â  Â  Â  Â  Â  Â  Â  Â  disabled={!selectedImage || isProcessing}
Â  Â  Â  Â  Â  Â  Â  Â  className="w-full h-12 text-base gradient-primary hover:opacity-90 transition-opacity"
Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  {isProcessing ? (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Loader2 className="w-5 h-5 mr-2 animate-spin" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Processing...
Â  Â  Â  Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Box className="w-5 h-5 mr-2" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Generate 3D Model
Â  Â  Â  Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  </Button>

Â  Â  Â  Â  Â  Â  Â  <Button
Â  Â  Â  Â  Â  Â  Â  Â  onClick={handleExport}
Â  Â  Â  Â  Â  Â  Â  Â  disabled={!mesh || isProcessing}
Â  Â  Â  Â  Â  Â  Â  Â  variant="outline"
Â  Â  Â  Â  Â  Â  Â  Â  className="w-full h-12 text-base border-primary/30 hover:bg-primary/10"
Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  <Download className="w-5 h-5 mr-2" />
Â  Â  Â  Â  Â  Â  Â  Â  Download OBJ
Â  Â  Â  Â  Â  Â  Â  </Button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </Card>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {/* Info Cards */}
Â  Â  Â  Â  <div className="grid md:grid-cols-3 gap-4">
Â  Â  Â  Â  Â  <Card className="p-4 bg-card/50 border-primary/20">
Â  Â  Â  Â  Â  Â  <h3 className="font-semibold text-primary mb-2">ðŸ”’ Privacy First</h3>
Â  Â  Â  Â  Â  Â  <p className="text-sm text-muted-foreground">
Â  Â  Â  Â  Â  Â  Â  All processing happens locally in your browser. No data is uploaded to any server.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  </Card>
Â  Â  Â  Â  Â  <Card className="p-4 bg-card/50 border-primary/20">
Â  Â  Â  Â  Â  Â  <h3 className="font-semibold text-primary mb-2">âš¡ WebGL Accelerated</h3>
Â  Â  Â  Â  Â  Â  <p className="text-sm text-muted-foreground">
Â  Â  Â  Â  Â  Â  Â  Powered by TensorFlow.js with WebGL backend for fast performance.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  </Card>
Â  Â  Â  Â  Â  <Card className="p-4 bg-card/50 border-primary/20">
Â  Â  Â  Â  Â  Â  <h3 className="font-semibold text-primary mb-2">ðŸ“¦ Export Ready</h3>
Â  Â  Â  Â  Â  Â  <p className="text-sm text-muted-foreground">
Â  Â  Â  Â  Â  Â  Â  Export to OBJ format compatible with Blender, Unity, and other 3D tools.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  </Card>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  );
};

export default Index;
